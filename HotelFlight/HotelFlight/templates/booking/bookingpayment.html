{% extends "search/base.html" %}

{% load static %}
{% load url_replace %}
{% load url_get %}
{% load widget_tweaks %}
{% load room_images %}


{% block title %}Book room at {{ hotel.Hotel_Name }}{% endblock title %}

{% block css %}
    <link rel="stylesheet" type="text/css" href="{% static 'search/styles/bootstrap4/bootstrap.min.css' %}">
    <link href="{% static 'search/plugins/font-awesome-4.7.0/css/font-awesome.min.css' %}" rel="stylesheet"
          type="text/css">
    <link rel="stylesheet" type="text/css" href="{% static 'search/styles/search.css' %}">
    <link rel="stylesheet" type="text/css" href="{% static 'search/styles/single_listing_styles.css' %}">
    <link rel="stylesheet" type="text/css" href="{% static 'search/styles/responsive.css' %}">
    <link rel="stylesheet" type="text/css" href="{% static 'gijgo/js/gijgo.min.css' %}">
    <link rel="stylesheet" type="text/css" href="{% static 'adminpanel/sidebar.css' %}">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css"
          integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">

{% endblock css %}

{% block content %}

    <div class="offers">
        <div class="hero-image"
             style="background-image: linear-gradient(rgba(0, 0, 0, 0.5), rgba(0, 0, 0, 0.5)), url({% static 'search/images/single_background.jpg' %})">
            <div class="hero-text">
                <h1 style="margin-top:150px">Advanced payment</h1>
            </div>
        </div>

        <div class="">
            <div class="row">
                <div class="col-lg-3" style="display: flex">
                    <div class="search" style="align-items: stretch">
                        <div class="search_inner">
                            <!-- Search Contents -->

                            <div class="container fill_height no-padding">
                                <div class="row no-margin">
                                    <div class="col  no-padding">
                                        <!-- Search Tabs -->

                                        <div class="search_tabs_container">
                                            <div class="search_tabs d-flex flex-lg-row flex-column align-items-lg-center align-items-start justify-content-lg-between justify-content-start">
                                                <div class="search_tab active d-flex flex-row align-items-center justify-content-lg-center justify-content-start">
                                                    <img src="{% static 'search/images/suitcase.png' %}"
                                                         alt=""><span>hotels</span>
                                                </div>
                                                <div class="search_tab d-flex flex-row align-items-center justify-content-lg-center justify-content-start">
                                                    <img src="{% static 'search/images/departure.png' %}" alt="">flights
                                                </div>
                                            </div>
                                        </div>


                                        <div class="search_panel active">
                                            <form action="{% url 'searchHotelPage' %} " id="search_form_1" method="get"
                                                  class="search_panel_content d-flex flex-lg-row flex-column align-items-lg-center align-items-start justify-content-lg-between justify-content-start">
                                                <div class="search_item">
                                                    <div>destination</div>
                                                    {% render_field hotelForm.hoteldest class="destination search_input" placeholder=hotelForm.hoteldest.label value=request.GET.hoteldest %}
                                                </div>
                                                <div class="search_item">
                                                    <div>check in</div>
                                                    {% render_field hotelForm.checkin class="check_in search_input" placeholder=hotelForm.checkin.label %}
                                                </div>
                                                <div class="search_item">
                                                    <div>check out</div>
                                                    {% render_field hotelForm.checkout class="check_out search_input" placeholder=hotelForm.checkout.label %}
                                                </div>
                                                <div class="search_item">
                                                    <div>room</div>
                                                    {% render_field hotelForm.room class="search_input room" placeholder=hotelForm.room.label %}
                                                </div>
                                                <div class="search_item">
                                                    <div>adults</div>
                                                    {% render_field hotelForm.adult class="search_input" placeholder=hotelForm.adult.label %}
                                                </div>
                                                <button class="button search_button">
                                                    search<span></span><span></span><span></span>
                                                </button>
                                                {% csrf_token %}
                                            </form>
                                        </div>


                                        <!-- Search Panel -->

                                        <div class="search_panel">
                                            <form action="{% url 'searchFlightPage' %}" id="search_form_2"
                                                  class="search_panel_content d-flex flex-lg-row flex-column align-items-lg-center align-items-start justify-content-lg-between justify-content-start">

                                                <div class="search_item">
                                                    <div>from</div>
                                                    {% render_field flightForm.source class="from search_input" placeholder=flightForm.source.label %}
                                                </div>
                                                <div class="search_item">
                                                    <div>to</div>
                                                    {% render_field flightForm.dest class="to search_input" placeholder=flightForm.dest.label %}
                                                </div>
                                                <div class="search_item">
                                                    <div>depart</div>
                                                    {% render_field flightForm.depart class="from search_input" placeholder=flightForm.depart.label %}
                                                </div>
                                                <div class="search_item">
                                                    <div>adults</div>
                                                    {% render_field flightForm.adult class="search_input" placeholder=flightForm.adult.label %}
                                                </div>
                                                <div class="search_item">
                                                    <div>children</div>
                                                    {% render_field flightForm.children class="search_input" placeholder=flightForm.children.label %}
                                                </div>
                                                <button class="button search_button">
                                                    search<span></span><span></span><span></span>
                                                </button>
                                                {% csrf_token %}
                                            </form>
                                        </div>


                                    </div>

                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-lg-9" style="margin-top:25px;margin-left:0px;">
                    <div class="container">
                        <div class="row">
                            <div class="col-lg-12">
                                <div class="">
                                    <div style="">
                                        <!-- Title -->
                                        <div class="hotel_title_container d-flex flex-lg-row flex-column">
                                            <div class="hotel_title_content">
                                                <h1 class="hotel_title">{{ hotel.Hotel_Name }}</h1>
                                                <div class="rating_r rating_r_4 hotel_rating">
                                                    <i></i>
                                                    <i></i>
                                                    <i></i>
                                                    <i></i>
                                                    <i></i>
                                                </div>
                                                <div class="hotel_location">{{ hotel.Address }},{{ hotel.Hotel_Location }},{{ hotel.Hotel_Country }}</div>
                                            </div>
                                        </div>

                                        <!-- Room-->
                                        <div class="rooms">
                                            <h3>Selected room :</h3>
                                            <hr>
                                            <div class="room">
                                                <div class="row no-margin no-padding">
                                                    <div class="col-lg-3 no-padding no-margin">
                                                        <div class="">
                                                            {% room_images hotel.uid room.roomID as roomImages %}
                                                            {% with hotel.uid|stringformat:"i" as ID and room.roomID|stringformat:"i" as rID %}
                                                                {% for firstImage in roomImages %}
                                                                    {% if forloop.first %}
                                                                        <img src="{% static 'media/user_'|add:ID|add:'/room_'|add:rID|add:'/'|add:firstImage %}" alt="" width="100%" height="20%">
                                                                    {% endif %}
                                                                {% endfor %}
                                                            {% endwith %}
                                                        </div>
                                                    </div>
                                                    <div class="col-lg-7">
                                                        <div class="room_content">
                                                            <div class="room_title">{{ room.RoomType }} Room</div>
                                                            <div class="room_price">{{ room.NPrice }}৳/night</div>
                                                            <div class="room_text">Selected rooms
                                                                : {{ request.GET.room }}</div>
                                                            <div class="room_text">Single
                                                                bed: {{ room.SingleBedCount }}, Double
                                                                bed: {{ room.DoubleBedCount }}</div>
                                                            <div class="room_extra">
                                                                <ul type="circle">
                                                                    {% if room.Wifi %}
                                                                        <li>Wifi</li>
                                                                    {% endif %}
                                                                    {% if room.Complimentary_Breakfast %}
                                                                        <li>Complimentary Breakfast</li>
                                                                    {% endif %}
                                                                    {% if room.AirConditioner %}
                                                                        <li>Air-conditioned</li>
                                                                    {% endif %}
                                                                </ul>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="col-lg-2 text-lg-right">
                                                        Price:<br/>
                                                        <div class="offers_price">
                                                            {{ room.Price }}‎৳<br/>
                                                        </div>
                                                         <div class="room_price">
                                                                    {{ daysCount }} night{% if daysCount > 1 %}s{% endif %}
                                                         </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <hr>
                                        </div>

                                        <div class="contact_form_container">
                                            <div class="contact_title text-center">Confirm Booking</div>
                                            <div class="row" style="margin-top: 25px;">
                                                <div class="col-lg-12">
                                                    <div class="contact_item">
                                                        <div align="left">Enter valid card number :</div>
                                                        <input type="text" class="contact_form_email input_field"/>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="row" style="margin-top: 25px;">
                                                <div class="col-lg-5">
                                                    <div class="contact_item">
                                                        <div align="left">Expiry Date :</div>
                                                        <input type="text" class="contact_form_email input_field"/>
                                                    </div>
                                                </div>
                                                <div class="col-lg-2"> </div>
                                                <div class="col-lg-5">
                                                    <div class="contact_item">
                                                        <div align="left">CVV :</div>
                                                        <input type="text" class="contact_form_email input_field"/>
                                                    </div>
                                                </div>
                                            </div>


                                            <input type="hidden" name="hoteldest"
                                                   value="{{ request.GET.hoteldest }}"/>
                                            <input type="hidden" name="checkin"
                                                   value="{{ request.GET.checkin }}"/>
                                            <input type="hidden" name="checkout"
                                                   value="{{ request.GET.checkout }}"/>
                                            <input type="hidden" name="hid" value="{{ request.GET.hid }}"/>
                                            <input type="hidden" name="huid"
                                                   value="{{ request.GET.huid }}"/>
                                            <input type="hidden" name="hrid"
                                                   value="{{ request.GET.hrid }}"/>
                                            <input type="hidden" name="uid" value="{{ user.id }}"/>
                                            <input type="hidden" name="room" value="{{ request.GET.room }}"/>
                                            <a href="bookingok?{{ request.GET.urlencode }}">
                                                <button type="submit" id="form_submit_button"
                                                        class="form_submit_button button trans_200">Confrim booking
                                                </button>
                                            </a>
                                        </div>
                                        <body>
                                          <div class="wrapper">
                                          <script src="https://js.stripe.com/v3/"></script>

                                          <form action="/charge" method="post" id="payment-form">
                                            <div class="form-row">
                                              <label for="card-element">
                                                Credit or debit card
                                              </label>
                                              <div id="card-element" class="StripeElement StripeElement--empty"><div class="__PrivateStripeElement" style="margin: 0px !important; padding: 0px !important; border: none !important; display: block !important; background: transparent !important; position: relative !important; opacity: 1 !important;"><iframe frameborder="0" allowtransparency="true" scrolling="no" name="__privateStripeFrame5" allowpaymentrequest="true" src="https://js.stripe.com/v3/elements-inner-card-640577b7f19bc5d5de83444a3d538cbd.html#style[base][color]=%2332325d&amp;style[base][fontFamily]=%22Helvetica+Neue%22%2C+Helvetica%2C+sans-serif&amp;style[base][fontSmoothing]=antialiased&amp;style[base][fontSize]=16px&amp;style[base][::placeholder][color]=%23aab7c4&amp;style[invalid][color]=%23fa755a&amp;style[invalid][iconColor]=%23fa755a&amp;componentName=card&amp;wait=false&amp;rtl=false&amp;keyMode=test&amp;origin=https%3A%2F%2Fstripe.com&amp;referrer=https%3A%2F%2Fstripe.com%2Fdocs%2Fstripe-js&amp;controllerId=__privateStripeController1" title="Secure payment input frame" style="border: none !important; margin: 0px !important; padding: 0px !important; width: 1px !important; min-width: 100% !important; overflow: hidden !important; display: block !important; user-select: none !important; height: 19.2px;"></iframe><input class="__PrivateStripeElement-input" aria-hidden="true" aria-label=" " autocomplete="false" maxlength="1" style="border: none !important; display: block !important; position: absolute !important; height: 1px !important; top: 0px !important; left: 0px !important; padding: 0px !important; margin: 0px !important; width: 100% !important; opacity: 0 !important; background: transparent !important; pointer-events: none !important; font-size: 16px !important;"></div></div>

                                              <!-- Used to display form errors. -->
                                              <div id="card-errors" role="alert"></div>
                                            </div>

                                            <button>Submit Payment</button>
                                          </form>
                                          </div>
                                          <div id="stripe-token-handler" class="is-hidden">Success! Got token: <span class="token"></span></div>


                                        <script nonce="">  // Create a Stripe client.
                                          var stripe = Stripe('pk_test_TYooMQauvdEDq54NiTphI7jx');

                                          // Create an instance of Elements.
                                          var elements = stripe.elements();

                                          // Custom styling can be passed to options when creating an Element.
                                          // (Note that this demo uses a wider set of styles than the guide below.)
                                          var style = {
                                            base: {
                                              color: '#32325d',
                                              fontFamily: '"Helvetica Neue", Helvetica, sans-serif',
                                              fontSmoothing: 'antialiased',
                                              fontSize: '16px',
                                              '::placeholder': {
                                                color: '#aab7c4'
                                              }
                                            },
                                            invalid: {
                                              color: '#fa755a',
                                              iconColor: '#fa755a'
                                            }
                                          };

                                          // Create an instance of the card Element.
                                          var card = elements.create('card', {style: style});

                                          // Add an instance of the card Element into the `card-element` <div>.
                                          card.mount('#card-element');

                                          // Handle real-time validation errors from the card Element.
                                          card.addEventListener('change', function(event) {
                                            var displayError = document.getElementById('card-errors');
                                            if (event.error) {
                                              displayError.textContent = event.error.message;
                                            } else {
                                              displayError.textContent = '';
                                            }
                                          });

                                          // Handle form submission.
                                          var form = document.getElementById('payment-form');
                                          form.addEventListener('submit', function(event) {
                                            event.preventDefault();

                                            stripe.createToken(card).then(function(result) {
                                              if (result.error) {
                                                // Inform the user if there was an error.
                                                var errorElement = document.getElementById('card-errors');
                                                errorElement.textContent = result.error.message;
                                              } else {
                                                // Send the token to your server.
                                                stripeTokenHandler(result.token);
                                              }
                                            });
                                          });

                                          // Submit the form with the token ID.
                                          function stripeTokenHandler(token) {
                                            // Insert the token ID into the form so it gets submitted to the server
                                            var form = document.getElementById('payment-form');
                                            var hiddenInput = document.createElement('input');
                                            hiddenInput.setAttribute('type', 'hidden');
                                            hiddenInput.setAttribute('name', 'stripeToken');
                                            hiddenInput.setAttribute('value', token.id);
                                            form.appendChild(hiddenInput);

                                            // Submit the form
                                            form.submit();
                                          }

                                          var successElement = document.getElementById('stripe-token-handler');
                                          document.querySelector('.wrapper').addEventListener('click', function() {
                                            successElement.className = 'is-hidden';
                                          });

                                          // Not in demo.
                                          function stripeTokenHandler(token) {
                                            successElement.className = '';
                                            successElement.querySelector('.token').textContent = token.id;
                                          }
                                        </script><iframe frameborder="0" allowtransparency="true" scrolling="no" name="__privateStripeController1" allowpaymentrequest="true" src="https://js.stripe.com/v3/controller-dc8e395a0fd4248305d24f1a70ce37dc.html#apiKey=pk_test_TYooMQauvdEDq54NiTphI7jx&amp;stripeJsId=7253293d-7d94-416c-a568-be672bce4450&amp;origin=https%3A%2F%2Fstripe.com&amp;referrer=https%3A%2F%2Fstripe.com%2Fdocs%2Fstripe-js&amp;controllerId=__privateStripeController1" aria-hidden="true" tabindex="-1" style="border: none !important; margin: 0px !important; padding: 0px !important; width: 1px !important; min-width: 100% !important; overflow: hidden !important; display: block !important; visibility: hidden !important; position: fixed !important; height: 1px !important; pointer-events: none !important; user-select: none !important;"></iframe>

                                          <iframe frameborder="0" allowtransparency="true" scrolling="no" name="__privateStripeMetricsController0" allowpaymentrequest="true" src="https://js.stripe.com/v2/m/outer.html#url=https%3A%2F%2Fstripe.com%2Fdocs%2Fstripe-js&amp;title=&amp;referrer=&amp;muid=8605ce11-b230-4fe1-b1b1-a49b59a25fbc&amp;sid=6f12decf-287b-41d6-a2ac-2c9807325ff9&amp;preview=true" aria-hidden="true" tabindex="-1" style="border: none !important; margin: 0px !important; padding: 0px !important; width: 1px !important; min-width: 100% !important; overflow: hidden !important; display: block !important; visibility: hidden !important; position: fixed !important; height: 1px !important; pointer-events: none !important; user-select: none !important;"></iframe>
                                        </body>

                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock content %}

{% block jscript %}
<script>
        function getAllUrlParams(url) {
      // get query string from url (optional) or window
      var queryString = url ? url.split('?')[1] : window.location.search.slice(1);
      // we'll store the parameters here
      var obj = {};
      // if query string exists
      if (queryString) {
        // stuff after # is not part of query string, so get rid of it
        queryString = queryString.split('#')[0];
        // split our query string into its component parts
        var arr = queryString.split('&');
        for (var i = 0; i < arr.length; i++) {
          // separate the keys and the values
          var a = arr[i].split('=');
          // set parameter name and value (use 'true' if empty)
          var paramName = a[0];
          var paramValue = typeof (a[1]) === 'undefined' ? true : a[1];
          // (optional) keep case consistent
          paramName = paramName.toLowerCase();
          if (typeof paramValue === 'string') paramValue = paramValue.toLowerCase();
          // if the paramName ends with square brackets, e.g. colors[] or colors[2]
          if (paramName.match(/\[(\d+)?\]$/)) {
            // create key if it doesn't exist
            var key = paramName.replace(/\[(\d+)?\]/, '');
            if (!obj[key]) obj[key] = [];
            // if it's an indexed array e.g. colors[2]
            if (paramName.match(/\[\d+\]$/)) {
              // get the index value and add the entry at the appropriate position
              var index = /\[(\d+)\]/.exec(paramName)[1];
              obj[key][index] = paramValue;
            } else {
              // otherwise add the value to the end of the array
              obj[key].push(paramValue);
            }
          } else {
            // we're dealing with a string
            if (!obj[paramName]) {
              // if it doesn't exist, create property
              obj[paramName] = paramValue;
            } else if (obj[paramName] && typeof obj[paramName] === 'string'){
              // if property does exist and it's a string, convert it to an array
              obj[paramName] = [obj[paramName]];
              obj[paramName].push(paramValue);
            } else {
              // otherwise add the property
              obj[paramName].push(paramValue);
            }
          }
        }
      }
      return obj;
    }
    let jsTomorrow = new Date();
    jsTomorrow.setDate(new Date().getDate()+1);
    let today = new Date().getFullYear() + "-" + ("0" + (new Date().getMonth() + 1)).slice(-2) + "-" +
        ("0" + new Date().getDate()).slice(-2);
    let tomorrow = jsTomorrow.getFullYear() + "-" + ("0" + (jsTomorrow.getMonth() + 1)).slice(-2) + "-" +
        ("0" + jsTomorrow.getDate()).slice(-2);

    $('#id_checkin').datepicker({
        uiLibrary: 'bootstrap4',
        value: getAllUrlParams().checkin ,
        minDate: today,
        format: 'yyyy-mm-dd',
        size: 'small'
    });
    $('#id_checkout').datepicker({
        uiLibrary: 'bootstrap4',
        value: getAllUrlParams().checkout,
        minDate: tomorrow,
        format: 'yyyy-mm-dd',
        size: 'small'
    });
    $('#id_depart').datepicker({
        uiLibrary: 'bootstrap4',
        value: getAllUrlParams().depart,
        minDate: today,
        format: 'yyyy-mm-dd',
        size: 'small'
    });

    // Create a Stripe client.
    var stripe = Stripe('pk_test_TYooMQauvdEDq54NiTphI7jx');

    // Create an instance of Elements.
    var elements = stripe.elements();

    // Custom styling can be passed to options when creating an Element.
    // (Note that this demo uses a wider set of styles than the guide below.)
    var style = {
      base: {
        color: '#32325d',
        fontFamily: '"Helvetica Neue", Helvetica, sans-serif',
        fontSmoothing: 'antialiased',
        fontSize: '16px',
        '::placeholder': {
          color: '#aab7c4'
        }
      },
      invalid: {
        color: '#fa755a',
        iconColor: '#fa755a'
      }
    };

    // Create an instance of the card Element.
    var card = elements.create('card', {style: style});

    // Add an instance of the card Element into the `card-element` <div>.
    card.mount('#card-element');

    // Handle real-time validation errors from the card Element.
    card.addEventListener('change', function(event) {
      var displayError = document.getElementById('card-errors');
      if (event.error) {
        displayError.textContent = event.error.message;
      } else {
        displayError.textContent = '';
      }
    });

    // Handle form submission.
    var form = document.getElementById('payment-form');
    form.addEventListener('submit', function(event) {
      event.preventDefault();

      stripe.createToken(card).then(function(result) {
        if (result.error) {
          // Inform the user if there was an error.
          var errorElement = document.getElementById('card-errors');
          errorElement.textContent = result.error.message;
        } else {
          // Send the token to your server.
          stripeTokenHandler(result.token);
        }
      });
    });

    // Submit the form with the token ID.
    function stripeTokenHandler(token) {
      // Insert the token ID into the form so it gets submitted to the server
      var form = document.getElementById('payment-form');
      var hiddenInput = document.createElement('input');
      hiddenInput.setAttribute('type', 'hidden');
      hiddenInput.setAttribute('name', 'stripeToken');
      hiddenInput.setAttribute('value', token.id);
      form.appendChild(hiddenInput);

      // Submit the form
      form.submit();
    }
</script>
{% endblock jscript%}
